# Martocci Mayhem Microsites

This repository contains the generated microsite files for Martocci Mayhem channels. These static sites are served via GitHub Pages at `https://videos.martoccimayhem.com/{slug}`.

## Directory Structure

```
mm-sites/
├── .gitignore              # Prevents node_modules and temp files from being tracked
├── package.json            # Dependencies for preview server
├── vite.config.js          # Vite configuration for local preview
├── scripts/                # Build and preview scripts
├── _templates/             # HTML templates used for generation
│   ├── index_template.html
│   └── video_template.html
├── dist/                   # GENERATED SITES (tracked in git)
│   ├── index.html          # Preview server landing page
│   ├── martocci-mayhem/    # Main channel site
│   │   ├── index.html
│   │   ├── meta.json
│   │   ├── videos.json
│   │   ├── slugs.json
│   │   ├── assets/
│   │   ├── images/
│   │   └── videos/
│   └── mayhem-maker/       # Secondary channel site
│       └── ...
└── node_modules/           # NOT tracked (ignored by .gitignore)
```

## Important Notes

### ✅ What IS Tracked in Git

- `dist/` folder and all its contents
  - This is where generated sites live
  - These files ARE committed to git
  - This is what GitHub Pages serves
- `_templates/` folder
- Configuration files (`package.json`, `vite.config.js`, etc.)
- `.gitignore` file

### ❌ What is NOT Tracked in Git

- `node_modules/` - Dependencies (install with `npm install`)
- `.temp-*` folders - Temporary build directories
- `.backup-*` folders - Backup directories from atomic swaps
- Environment files (`.env`, `.env.local`)
- OS files (`.DS_Store`, `Thumbs.db`)

### 🚫 Old Structure (Deprecated)

Previously, sites were generated directly at the root level:
- `jessica-konrad/` - OLD LOCATION (now removed)
- `george-ramos/` - OLD LOCATION (now removed)
- `martocci-mayhem/` - OLD LOCATION (now in `dist/`)
- `mayhem-maker/` - OLD LOCATION (now in `dist/`)

**These root-level folders have been removed from git tracking.** All sites must now be in the `dist/` subdirectory.

## Site Generation Process

Sites are generated by the `mm-worker` service:

1. **Trigger**: POST to `/api/admin/enqueue-render` with `{channelId}`
2. **Queue**: Job added to BullMQ queue
3. **Generation**: Worker processes job
   - Generates to temporary directory (`.temp-{slug}-{timestamp}`)
   - Validates site is complete
   - Atomically swaps with existing site
   - Creates backup (`.backup-{slug}`)
4. **Publishing**: Copies to `mm-site` GitHub repo
5. **Deployment**: GitHub Pages auto-deploys

## Atomic Generation

Sites use atomic generation to prevent data loss:

```
1. Generate → .temp-{slug}-{timestamp}/
2. Validate complete
3. Backup existing → .backup-{slug}/
4. Atomic swap: .temp → dist/{slug}/
5. Cleanup old backups (7 days)
```

If generation fails, the old site remains untouched.

## Local Preview

Start the preview server:

```bash
cd mm-sites
npm install
npm run preview
```

Visit `http://localhost:4400` to preview generated sites.

## Configuration

Environment variables (in `mm-web/.env` and `mm-worker/.env`):

```bash
# Site URLs
NEXT_PUBLIC_MMSITE_URL=https://videos.martoccimayhem.com
MMSITES_PREVIEW_PORT=4400
MMSITES_PREVIEW_MODE=0  # 0 = production, 1 = local preview

# Directories
MMSITE_REPO_DIR=mm-site    # GitHub Pages repo name
MMSITES_OUTPUT_DIR=mm-sites  # This repo name

# GitHub Publishing
GIT_REPO_URL=git@github.com:MartocciMayhem/mm-site.git
GIT_USER_NAME=Martocci Mayhem Bot
GIT_USER_EMAIL=bot@martoccimayhem.com
GITHUB_PAT=github_pat_...
```

## Troubleshooting

### Sites Keep Getting Removed

**Fixed!** This was caused by:
1. No `.gitignore` file → `node_modules/` was committed
2. Old root-level site folders still tracked in git
3. Empty orphaned folders confusing git

**Solution:**
- Added proper `.gitignore`
- Removed `node_modules/` from tracking
- Removed old root-level site folders
- All sites now properly in `dist/`

### Site Shows "fallback: true"

This means site generation failed. Check:
1. Worker logs for errors
2. Redis/BullMQ queue status
3. Database connection
4. Asset files (images, CSS, JS)

### Sites Not Publishing to GitHub

Check:
1. `GITHUB_PAT` is valid
2. `GIT_REPO_URL` is correct
3. Git credentials are configured
4. Network connection to GitHub

## Related Files

**Generation:**
- `mm-web/src/lib/site-renderer.ts` - Main generation logic
- `mm-worker/src/services/site-generation.ts` - Worker service
- `mm-web/src/lib/site-config.ts` - Path configuration

**Publishing:**
- `mm-web/src/lib/github-publisher.ts` - GitHub integration
- `mm-web/src/app/api/admin/enqueue-render/route.ts` - API endpoint

**Serving:**
- `mm-web/src/app/api/sites/status/route.ts` - Health check
- `mm-web/src/app/api/sites/slugmap/route.ts` - Slug mapping

## Maintenance

### Regenerating a Site

```bash
# Via API
curl -X POST http://localhost:3000/api/admin/enqueue-render \
  -H "Content-Type: application/json" \
  -d '{"channelId": "channel-id-here"}'
```

### Cleaning Up Backups

Backups older than 7 days are automatically cleaned up during site generation.

### Manual Cleanup

```bash
# Remove all temp and backup directories
cd mm-sites
rm -rf .temp-* .backup-*
```

## Git Workflow

**DO commit:**
- Changes to `dist/` (generated sites)
- Updates to templates
- Configuration changes

**DON'T commit:**
- `node_modules/`
- Temporary build files
- Backup directories
- Environment files

**Commit message example:**
```
Update martocci-mayhem site (202 videos)
```

## Migration Notes (Oct 2025)

On October 26, 2025, the following changes were made:

1. **Created `.gitignore`** to prevent `node_modules/` tracking
2. **Removed `node_modules/` from git** (2000+ files removed)
3. **Removed old root-level site folders** (`jessica-konrad/`, `george-ramos/`, old `martocci-mayhem/`, old `mayhem-maker/`)
4. **Standardized structure** - All sites now in `dist/` subdirectory
5. **Documented atomic generation** process

This fixes the issue where sites were "disappearing" from git.
